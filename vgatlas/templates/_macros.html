{% macro block(object, path=None, in_list=False, depth=0, first=False, last=False, root=None) %}
    {% if isinstance(object, datamijn.Palette) %}
        <div class="d-flex flex-row" style="display: inline-block;">
            {% for i, color in enumerate(object) %}
                {{ color | block(path + [i], in_list=True, first=loop.first, last=loop.last) }}
            {% endfor %}
        </div>
    {% elif isinstance(object, datamijn.RGBColor) %}
        <div class="p-2 {% if first %}border-top border-left border-bottom{% elif last %}border-top border-right border-bottom{% else %}border-top border-bottom{% endif %}"
            style="display: inline-block; width: 32px; height: 32px;
            background-color: {{object.hex}};"></div>
    {% elif isinstance(object, datamijn.Image) or isinstance(object, datamijn.Tileset): %}
        {% if hasattr(object, "_filename") %}
            <img src="{{ url_for(root+'.static', filename=object._filename) }}">
        {% else %}
            {{ object | inline }}
        {% endif %}
    {% elif isinstance(object, datamijn.String) %}
        {% for token in object -%}
            {%- if isinstance(token, str) -%}
                {{- token -}}
            {%- elif isinstance(token, datamijn.Terminator) -%}
                
            {%- else -%}
                <span class="text-info">{{ token }}</span>
            {%- endif -%}
        {%- endfor %}
    {% elif isinstance(object, dict) %}
        {% if not in_list %}
        <div class="card">
        {% endif %}
            <dl class="row card-body mb-0">
                {% for key, value in object.items() %}
                    {% if not key.startswith("_") %}
                        <dt class="col-sm-3">
                            {% if path %}
                                <a href="{{ url_for(root+'.object',
                                  path=pathjoin(path + [key])) }}"
                                  data-toggle="tooltip" data-placement="top" title="&lt;{{ type(value).__name__ }}&gt;">
                                    {{ key }}
                                </a>
                            {% else %}
                                <span data-toggle="tooltip" data-placement="top" title="&lt;{{ type(value).__name__ }}&gt;">
                                    {{ key }}
                                </span>
                            {% endif %}
                        </dt>
                        <dd class="col-sm-9">{{ value | block(path=path + [key] if path else None, depth=depth+1) }}</dd>
                    {% endif %}
                {% endfor %}
            </dl>
        {% if not in_list %}
        </div>
        {% endif %}
    {% elif isinstance(object, type([])) %}
        {% if getattr(object._type, "_char", False) %} {# XXX #}
            {{ str(object) }}
        {% else %}
            {% if issubclass(object._type, datamijn.Container) %}
                {{ object | table(path=path, root=root) }}
            {% else %}
                <ul class="list-group position-relative">
                    {% set show = 5 if (depth and len(object) > 5) else len(object) %}
                    {% for i, value in enumerate(object[:show]) %}
                        <li class="list-group-item">
                            <a {% if path %}href="{{ url_for(root+'.object',
                              path=pathjoin(path + [i])) }}"{% endif %}
                              class="position-absolute" style="left: 0px; top: -5px;">
                                <span class="badge  badge-pill">{{i}}</span>
                            </a>
                            {{ value | block(path=path + [i] if path else None,  in_list=True, depth=depth+1) }}
                        </li>
                    {% endfor %}
                    {% if show == 5 and len(object) > 5 %}
                        <details>
                            <summary>{{ len(object)-show }} more items...</summary>
                            {% for i, value in enumerate(object[show:]) %}
                                <li class="list-group-item">
                                    <a {% if path %}href="{{ url_for(root+'.object',
                                      path=pathjoin(path + [i+show])) }}"{% endif %}>
                                        <span class="badge badge-secondary badge-pill">{{i+show}}</span>
                                    </a>
                                    {{ value | block(path=path + [i+show] if path else None,  in_list=True, depth=depth+1) }}
                                </li>
                            {% endfor %}
                        </details>
                    {% endif %}
                </ul>
            {% endif %}
        {% endif %}
    {% elif isinstance(object, datamijn.ForeignKey) %}
        {% set fpath = list(object._field_name) + [object._result] %}
        <a href="{{ url_for(root+'.object', path=pathjoin(fpath)) }}">
            {% if depth == 0 %}
                {{ object._object | block(path=fpath, depth=depth+1) }}
            {% else %}
                {{ object._object | inline }}
            {% endif %}
        </a>
    {% else %}
        {{ object }}
    {% endif %}
{% endmacro %}

{% macro table(object, columns, path, root) %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">#</th>
                {% for name in columns %}
                    <th scope="col">
                        {{ name }}
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for i, row in enumerate(object) %}
                <tr>
                    <th scope="row">
                        <a {% if path %}href="{{ url_for(root+'.object',
                                  path=pathjoin(path + [i])) }}">{% endif %}
                            {{ i }}
                        </a>
                    </th>
                    {% for name in columns %}
                        <td>
                            {{ getattr(row, name) | inline }}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endmacro %}

{% macro breadcrumb() %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for(root+'.index') }}">{{ root }}</a>
                </li>
            {% for i, segment in enumerate(path) %}
                <li class="breadcrumb-item {% if loop.last %}active{% endif %}">
                    <a href=" {{ url_for(root+'.object', path=pathjoin(path[:i+1])) }} ">{{ segment }}</a>
                </li>
            {% endfor %}
        </ol>
    </nav>
{% endmacro %}
{% macro prevnext() %}
    {% if prev != None or next != None %}
        <nav aria-label="...">
            <ul class="pagination pagination-lg justify-content-center">
                <li class="page-item {% if prev == None %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for(root+'.object', path=pathjoin(path[:-1] + [index-1])) }}" tabindex="-1">
                        {% if prev != None %}
                            #{{ index-1 }}
                            {{ prev | inline }}
                        {% else %} - {% endif %}
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link">
                        #{{ index }}
                        {{ object | inline }}
                    </a>
                </li>
                <li class="page-item {% if next == None %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for(root+'.object', path=pathjoin(path[:-1] + [index+1])) }}">
                        {% if next != None %}
                            #{{ index+1 }}
                            {{ next | inline }}
                        {% else %} - {% endif %}
                    </a>
                </li>
            </ul>
        </nav>
    {% endif %}
{% endmacro %}
